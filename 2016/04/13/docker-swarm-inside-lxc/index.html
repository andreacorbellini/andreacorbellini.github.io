<!doctype html>
<html lang="en">
  <head>
      <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/png" sizes="16x16" href="https://andrea.corbellini.name/theme/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://andrea.corbellini.name/theme/favicon-32x32.png">
    <link href="https://andrea.corbellini.name/feed.atom" type="application/atom+xml" rel="alternate" title="Andrea Corbellini Atom Feed">
    <link href="https://andrea.corbellini.name/feed.rss" type="application/rss+xml" rel="alternate" title="Andrea Corbellini RSS Feed">
      <link rel="stylesheet" href="https://andrea.corbellini.name/theme/css/style.min.css?75d599d8">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700%7COpen+Sans:400,700">
      <script src="https://andrea.corbellini.name/theme/js/scripts.min.js?6c5f3521" defer></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [ [ '$', '$' ], [ '\\(','\\)' ] ]
      },
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js" defer></script>
    <script src="https://gc.zgo.at/count.js" defer data-goatcounter="https://cor.goatcounter.com/count"></script>
    <link href="https://ubuntu.social/@andrea" rel="me">

    <script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" defer></script>
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        tocbot.init({
          tocSelector: '.article-toc nav',
          contentSelector: 'main .article-body',
          headingSelector: 'h1, h2, h3, h4, h5, h6',
          activeLinkClass: 'active',
        });
      });
    </script>
      <meta name="tags" content="docker">
      <meta name="tags" content="swarm">
      <meta name="tags" content="lxc">
      <meta name="tags" content="containers">
      <meta name="tags" content="distributed-computing">
    <link rel="canonical" href="https://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/">
    <meta property="og:locale" content="en">
    <meta property="og:title" content="Running Docker Swarm inside LXC (outdated)">
    <meta property="og:author" content="Andrea Corbellini">
      <script>
        window.remark_config = {
          host: "https://remark42.fly.dev",
          site_id: "andrea.corbellini.name",
        }
      </script>
      <script src="https://remark42.fly.dev/web/embed.js" defer></script>
      <script src="https://remark42.fly.dev/web/counter.js" defer></script>
    <title>Running Docker Swarm inside LXC (outdated) - Andrea Corbellini</title>
  </head>
  <body>
    <header id="main-header">  <div class="main-navbar-wrapper">
    <nav class="main-navbar">
      <button type="button" class="main-navbar-expand"></button>
      <div class="main-navbar-sitename">
        <a href="https://andrea.corbellini.name/" rel="home">Andrea Corbellini</a>
      </div>
      <div class="main-navbar-links">
        <ul>
          <li><a href="https://andrea.corbellini.name/" rel="home">Home</a></li>
            <li><a href="https://andrea.corbellini.name/about/">About</a></li>
        </ul>
      </div>
    </nav>
  </div>
</header>
<main id="content">    <article class="article">
      <header>
        <h1><a href="https://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/" rel="bookmark" title="Running Docker Swarm inside LXC (outdated)">Running Docker Swarm inside LXC (outdated)</a></h1>
<ul class="article-details">
  <li><time datetime="2016-04-13T18:00:00+00:00">April 13, 2016</time></li>
  <li><a href="https://andrea.corbellini.name/category/information-technology/" title="Category" class="category">information-technology</a></li>
  <li><a href="https://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/#comments" title="Comments" class="comments"><span class="remark42__counter" data-url="https://andrea.corbellini.name/2016/04/13/docker-swarm-inside-lxc/"></span> Comments</a></li>
</ul>      </header>
      <div class="article-wrapper">
        <aside class="article-toc">
          <nav></nav>
        </aside>
        <div class="article-body"><p><strong>UPDATE:</strong> This article was written in 2016 and refers to a version of Docker Swarm that is now known as “legacy Swarm”. The newer Docker Swarm won’t work in LXC as described in this article.</p>
<p>I’ve been using <a href="https://docs.docker.com/swarm/">Docker Swarm</a> inside <a href="https://linuxcontainers.org/lxc/introduction/">LXC</a> containers for a while now, and I thought that I could share my experience with you. Due to their nature, LXC containers are pretty lightweight and require very few resources if compared to virtual machines. This makes LXC ideal for development and simulation purposes. Running Docker Swarm inside LXC requires a few steps that I’m going to show you in this tutorial.</p>
<p>Before we begin, a quick premise: LXC, Docker and Swarm can be configured in many different ways. Here I’m showing just my preferred setup: LXC with AppArmor disabled, Docker with the OverlayFS storage driver, Swarm with etcd discovery. There exist many other kind of configurations that can work under LXC &mdash; leave a comment if you want to know more.</p>
<p><strong>Overview:</strong></p>
<ol>
<li><a href="#step-1">Create the Swarm Manager container</a></li>
<li><a href="#step-2">Modify configuration for the Swarm Manager container</a></li>
<li><a href="#step-3">Load the OverlayFS module</a></li>
<li><a href="#step-4">Start the container and install Docker</a></li>
<li><a href="#step-5">Check if Docker is working</a></li>
<li><a href="#step-6">Set up the Swarm Manager</a></li>
<li><a href="#step-7">Create the Swarm Agents</a></li>
<li><a href="#step-8">Play with the Swarm</a></li>
</ol>
<p><strong>Terminology:</strong></p>
<ul>
<li>the <em>host</em> is the system that will create and start the LXC containers (e.g. your laptop);</li>
<li>the <em>manager</em> is the LXC container that will run the Swarm manager (it’ll run the <code>swarm manage</code> command);</li>
<li>an <em>agent</em> is one of the many LXC containers that will run a Swarm agent node (it’ll run the <code>swarm join</code> command);</li>
</ul>
<p>To avoid ambiguity, all commands will be prefixed with a prompt such as <code>root@host:~#</code>, <code>root@swarm-manager:~#</code> and <code>root@swarm-agent-1:~#</code>.</p>
<p><strong>Prerequisites:</strong></p>
<p>This tutorial assumes that you have at least a vague idea of what Docker and Docker Swarm are. You should also be familiar with the shell.</p>
<p>This tutorial has been successfully tested on Ubuntu 15.10 (that ships with Docker 1.6) and Ubuntu 16.04 LTS (Docker 1.10), but it may work on other distributions and Docker versions as well.</p>
<h1 id="step-1">Step 1: Create the Swarm Manager container</h1>
<p>Create a new LXC container with:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@host:~# </span>lxc-create<span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-n<span class="w"> </span>swarm-manager
</code></pre></div>

<p>When prompted, choose your favorite distribution and architecture. I chose <code>ubuntu</code> / <code>xenial</code> / <code>amd64</code>.</p>
<p><code>lxc-create</code> needs to run as root, <a href="https://www.stgraber.org/2014/01/17/lxc-1-0-unprivileged-containers/">unprivileged containers</a> won’t work. We could actually make Docker start inside an unprivileged container, the problem is that we wouldn’t be allowed to create block and character devices, and many Docker containers need this ability.</p>
<h1 id="step-2">Step 2: Modify the configuration for the Swarm Manager container</h1>
<p>Before starting the LXC container, open the file <code>/var/lib/lxc/swarm-manager/config</code> on the host and add the following configuration to the bottom of the file:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Distribution configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Container specific configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Network configuration</span>
<span class="c1"># ...</span>

<span class="c1"># Allow running Docker inside LXC</span>
lxc.aa_profile<span class="w"> </span><span class="o">=</span><span class="w"> </span>unconfined
lxc.cap.drop<span class="w"> </span><span class="o">=</span>
</code></pre></div>

<p>The first rule (<code>lxc.aa_profile = unconfined</code>) disables AppArmor confinement. The second one (<code>lxc.cap.drop =</code>) gives all capabilities to the processes in LXC container.</p>
<p>These two rules may seem harmful from a security standpoint, and in fact they are. However we must remember that we will be running Docker inside the LXC container. Docker already ships with its own AppArmor profile and the two rules above are needed exactly for the purposes of letting Docker talk to AppArmor.</p>
<p>So, while Docker itself won’t be confined, <strong>Docker containers will be confined</strong>, and this is an encouraging fact.</p>
<h1 id="step-3">Step 3: Load the OverlayFS module</h1>
<p>OverlayFS is shipped with Ubuntu, but not enabled by default. To enable it:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@host:~# </span>modprobe<span class="w"> </span>overlay
</code></pre></div>

<p>It is important to do this step before installing Docker. Docker supports various storage drivers and when Docker is installed for the first time it tries to detect the most appropriate one for the system. If Docker detects that OverlayFS is not loaded, it’ll fall back to the device mapper. There’s nothing wrong with the device mapper, we can make it work, however, as I said at the beginning, in this tutorial I’m focusing only on OverlayFS.</p>
<p>If you want to load OverlayFS at boot, instead of doing it manually after every reboot, add it to <code>/etc/modules-load.d/modules.conf</code>:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@host:~# </span><span class="nb">echo</span><span class="w"> </span>overlay<span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/modules-load.d/modules.conf
</code></pre></div>

<h1 id="step-4">Step 4: Start the container and install Docker</h1>
<p>It’s time to see if we did everything right!</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@host:~# </span>lxc-start<span class="w"> </span>-n<span class="w"> </span>swarm-manager
<span class="gp">root@host:~# </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span>swarm-manager
<span class="gp">root@swarm-manager:~# </span>apt<span class="w"> </span>update
<span class="gp">root@swarm-manager:~# </span>apt<span class="w"> </span>install<span class="w"> </span>docker.io
</code></pre></div>

<p>Installation should complete without any problem. If you get an error like this:</p>
<div class="highlight"><pre><span></span><code>Job for docker.service failed because the control process exited with error code. See &quot;systemctl status docker.service&quot; and &quot;journalctl -xe&quot; for details.
invoke-rc.d: initscript docker, action &quot;start&quot; failed.
dpkg: error processing package docker.io (--configure):
 subprocess installed post-installation script returned error exit status 1
</code></pre></div>

<p>It means that Docker failed to start. Try checking <code>systemctl status docker</code> as suggested, or run <code>docker daemon</code> manually. You might get an error like this:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>daemon
<span class="go">WARN[0000] devmapper: Udev sync is not supported. This will lead to unexpected behavior, data loss and errors. For more information, see https://docs.docker.com/reference/commandline/daemon/#daemon-storage-driver-option</span>
<span class="go">ERRO[0000] There are no more loopback devices available.</span>
<span class="go">ERRO[0000] [graphdriver] prior storage driver &quot;devicemapper&quot; failed: loopback attach failed</span>
<span class="go">FATA[0000] Error starting daemon: error initializing graphdriver: loopback attach failed</span>
</code></pre></div>

<p>In this case, Docker is using the devicemapper storage driver and is complaining about the lack of loopback devices. If that’s the case, check whether OverlayFS is loaded and reinstall Docker.</p>
<p>Or you might get an error like this:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>daemon
<span class="go">...</span>
<span class="go">FATA[0000] Error starting daemon: AppArmor enabled on system but the docker-default profile could not be loaded.</span>
</code></pre></div>

<p>It this other case, Docker is complaining about the fact that it can’t talk to AppArmor. Check the configuration for the LXC container.</p>
<h1 id="step-5">Step 5: Check if Docker is working</h1>
<p>Once you are all set, you should be able to use Docker: try running <code>docker info</code>, <code>docker ps</code> or launch a container:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>docker/whalesay<span class="w"> </span>cowsay<span class="w"> </span>burp!
<span class="go">Unable to find image &#39;docker/whalesay:latest&#39; locally</span>
<span class="go">latest: Pulling from docker/whalesay</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for docker/whalesay:latest</span>
<span class="go"> _______</span>
<span class="go">&lt; burp! &gt;</span>
<span class="go"> -------</span>
<span class="go">    \</span>
<span class="go">     \</span>
<span class="go">      \</span>
<span class="gp">                    #</span><span class="c1">#        .</span>
<span class="gp">              #</span><span class="c1"># ## ##       ==</span>
<span class="gp">           #</span><span class="c1"># ## ## ##      ===</span>
<span class="go">       /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;___/ ===</span>
<span class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</span>
<span class="go">       \______ o          __/</span>
<span class="go">        \    \        __/</span>
<span class="go">          \____\______/</span>
</code></pre></div>

<p>It appears to be working. By the way, we can check whether Docker is correctly confining containers. Try running a Docker container and check on the host the output of <code>aa-status</code>: you should see a process running with the <code>docker-default</code> profile. For example:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>ubuntu<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;while true; do sleep 1; echo -n zZ; done&#39;</span>
<span class="go">zZzZzZzZzZzZzZzZ...</span>

<span class="gp"># </span>On<span class="w"> </span>another<span class="w"> </span>shell
<span class="gp">root@host:~# </span>aa-status
<span class="go">apparmor module is loaded.</span>
<span class="go">5 profiles are loaded.</span>
<span class="go">5 profiles are in enforce mode.</span>
<span class="go">   /sbin/dhclient</span>
<span class="go">   /usr/lib/NetworkManager/nm-dhcp-client.action</span>
<span class="go">   /usr/lib/NetworkManager/nm-dhcp-helper</span>
<span class="go">   /usr/lib/connman/scripts/dhclient-script</span>
<span class="go">   docker-default</span>
<span class="go">0 profiles are in complain mode.</span>
<span class="go">4 processes have profiles defined.</span>
<span class="go">4 processes are in enforce mode.</span>
<span class="go">   /sbin/dhclient (797)</span>
<span class="go">   /sbin/dhclient (2832)</span>
<span class="go">   docker-default (6956)</span>
<span class="go">   docker-default (6973)</span>
<span class="go">0 processes are in complain mode.</span>
<span class="go">0 processes are unconfined but have a profile defined.</span>

<span class="gp">root@host:~# </span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">6956</span>
<span class="go">root      6956  4982  0 17:17 ?        00:00:00 bash -c while true; do sleep 1; echo -n zZ; done</span>
<span class="go">root      6973  6956  0 17:17 ?        00:00:00 sleep 1</span>
<span class="go">root      6982  6808  0 17:17 pts/3    00:00:00 grep --color=auto 6956</span>
</code></pre></div>

<p>Yay! Everything is running as expected: we launched a process inside a Docker container, and that process is running with the <code>docker-default</code> AppArmor profile. Once again: even if LXC is running unconfined, our Docker containers are not.</p>
<h1 id="step-6">Step 6: Set up the Swarm Manager</h1>
<p>That was the hardest part. Now we can proceed setting up Swarm as we would usually do.</p>
<p>As I said at the beginning, Swarm can be configured in many ways. In this tutorial I’ll show how to set it up with etcd discovery. First of all, we need the IP address of the LXC container:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>ifconfig<span class="w"> </span>eth0
<span class="go">eth0      Link encap:Ethernet  HWaddr 00:16:3e:8e:cb:43</span>
<span class="go">          inet addr:10.0.3.154  Bcast:10.0.3.255  Mask:255.255.255.0</span>
<span class="go">          inet6 addr: fe80::216:3eff:fe8e:cb43/64 Scope:Link</span>
<span class="go">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span>
<span class="go">          RX packets:23177 errors:0 dropped:0 overruns:0 frame:0</span>
<span class="go">          TX packets:20859 errors:0 dropped:0 overruns:0 carrier:0</span>
<span class="go">          collisions:0 txqueuelen:1000</span>
<span class="go">          RX bytes:147652946 (147.6 MB)  TX bytes:1455613 (1.4 MB)</span>
</code></pre></div>

<p><code>10.0.3.154</code> is my IP address. Let’s start etcd:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span><span class="nv">SWARM_MANAGER_IP</span><span class="o">=</span><span class="m">10</span>.0.3.154

<span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--restart<span class="o">=</span>always<span class="w"> </span>--name<span class="o">=</span>etcd<span class="w"> </span>-p<span class="w"> </span><span class="m">4001</span>:4001<span class="w"> </span>-p<span class="w"> </span><span class="m">2380</span>:2380<span class="w"> </span>-p<span class="w"> </span><span class="m">2379</span>:2379<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>quay.io/coreos/etcd<span class="w"> </span>-name<span class="w"> </span>etcd0<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-advertise-client-urls<span class="w"> </span>http://<span class="nv">$SWARM_MANAGER_IP</span>:2379,http://<span class="nv">$SWARM_MANAGER_IP</span>:4001<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-listen-client-urls<span class="w"> </span>http://0.0.0.0:2379,http://0.0.0.0:4001<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-initial-advertise-peer-urls<span class="w"> </span>http://<span class="nv">$SWARM_MANAGER_IP</span>:2380<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-listen-peer-urls<span class="w"> </span>http://0.0.0.0:2380<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-initial-cluster-token<span class="w"> </span>etcd-cluster-1<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-initial-cluster<span class="w"> </span><span class="nv">etcd0</span><span class="o">=</span>http://<span class="nv">$SWARM_MANAGER_IP</span>:2380<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>-initial-cluster-state<span class="w"> </span>new
<span class="go">Unable to find image &#39;quay.io/coreos/etcd:latest&#39; locally</span>
<span class="go">latest: Pulling from coreos/etcd</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for quay.io/coreos/etcd:latest</span>
<span class="go">e742278a97d2ad3f88658aa871903d20b4094e551969a03aa8332d3876fe5d0d</span>

<span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>ps
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                NAMES</span>
<span class="go">e742278a97d2        quay.io/coreos/etcd   &quot;/etcd -name etcd0 -a&quot;   32 seconds ago      Up 31 seconds       0.0.0.0:2379-2380-&gt;2379-2380/tcp, 0.0.0.0:4001-&gt;4001/tcp, 7001/tcp   etcd</span>
</code></pre></div>

<p>Replace <code>10.0.3.154</code> with the IP address of your LXC container.</p>
<p>Note that I’ve started etcd with <code>--restart=always</code>, so that every time etcd is automatically started when the LXC container starts. With this option, etcd will restart even if you explicitly stop it. Drop <code>--restart=always</code> if that’s not what you want.</p>
<p>Now we can start the Swarm manager:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--restart<span class="o">=</span>always<span class="w"> </span>--name<span class="o">=</span>swarm<span class="w"> </span>-p<span class="w"> </span><span class="m">3375</span>:3375<span class="w"> </span><span class="se">\</span>
<span class="w">                            </span>swarm<span class="w"> </span>manage<span class="w"> </span>-H<span class="w"> </span><span class="m">0</span>.0.0.0:3375<span class="w"> </span>etcd://<span class="nv">$SWARM_MANAGER_IP</span>:2379
<span class="go">Unable to find image &#39;swarm:latest&#39; locally</span>
<span class="go">latest: Pulling from library/swarm</span>
<span class="go">...</span>
<span class="go">Status: Downloaded newer image for swarm:latest</span>
<span class="go">8080c93c544ff92cc2cf682ff0bbc82e0d2dfb01e1f98f202c3a0801d3427330</span>

<span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>ps
<span class="go">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                                                NAMES</span>
<span class="go">46b556e73e87        swarm                 &quot;/swarm manage -H 0.0&quot;   3 seconds ago       Up 2 seconds        2375/tcp, 0.0.0.0:3375-&gt;3375/tcp                                     swarm</span>
<span class="go">e742278a97d2        quay.io/coreos/etcd   &quot;/etcd -name etcd0 -a&quot;   7 minutes ago       Up 7 minutes        0.0.0.0:2379-2380-&gt;2379-2380/tcp, 0.0.0.0:4001-&gt;4001/tcp, 7001/tcp   etcd</span>
</code></pre></div>

<p>Our Swarm manager is up and running. We can connect to it and issue a few commands:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>-H<span class="w"> </span>localhost:3375<span class="w"> </span>info
<span class="go">Containers: 0</span>
<span class="go"> Running: 0</span>
<span class="go"> Paused: 0</span>
<span class="go"> Stopped: 0</span>
<span class="go">Images: 0</span>
<span class="go">Server Version: swarm/1.1.3</span>
<span class="go">Role: primary</span>
<span class="go">Strategy: spread</span>
<span class="go">Filters: health, port, dependency, affinity, constraint</span>
<span class="go">Nodes: 0</span>
<span class="go">Plugins:</span>
<span class="go"> Volume:</span>
<span class="go"> Network:</span>
<span class="go">Kernel Version: 4.4.0-15-generic</span>
<span class="go">Operating System: linux</span>
<span class="go">Architecture: amd64</span>
<span class="go">CPUs: 0</span>
<span class="go">Total Memory: 0 B</span>
<span class="go">Name: d39c33295ef3</span>
</code></pre></div>

<p>As you can see there are no nodes connected, as we would expect. Everything looks good.</p>
<h1 id="step-7">Step 7: Create the Swarm Agents</h1>
<p>Our Swarm manager can’t do anything interesting without agent nodes. Creating new LXC containers for the agents is not much different from what we already did with the manager. To set up new agents in an automatic fashion I’ve created a script, so that you don’t need to repeat the steps manually:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-eu

<span class="nv">SWARM_MANAGER_IP</span><span class="o">=</span><span class="m">10</span>.0.3.154
<span class="nv">DOWNLOAD_DIST</span><span class="o">=</span>ubuntu
<span class="nv">DOWNLOAD_RELEASE</span><span class="o">=</span>xenial
<span class="nv">DOWNLOAD_ARCH</span><span class="o">=</span>amd64

<span class="k">for</span><span class="w"> </span>LXC_NAME<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">do</span>
<span class="w">    </span><span class="nv">LXC_PATH</span><span class="o">=</span><span class="s2">&quot;/var/lib/lxc/</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">LXC_ROOTFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LXC_PATH</span><span class="s2">/rootfs&quot;</span>

<span class="w">    </span><span class="c1"># Create the container.</span>
<span class="w">    </span>lxc-create<span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_DIST</span><span class="s2">&quot;</span><span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_RELEASE</span><span class="s2">&quot;</span><span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_ARCH</span><span class="s2">&quot;</span>

<span class="w">    </span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF &gt;&gt; &quot;$LXC_PATH/config&quot;</span>
<span class="s"># Allow running Docker inside LXC</span>
<span class="s">lxc.aa_profile = unconfined</span>
<span class="s">lxc.cap.drop =</span>
<span class="s">EOF</span>

<span class="w">    </span><span class="c1"># Start the container and wait for networking to start.</span>
<span class="w">    </span>lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
<span class="w">    </span>sleep<span class="w"> </span>10s

<span class="w">    </span><span class="c1"># Install Docker.</span>
<span class="w">    </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>apt-get<span class="w"> </span>update
<span class="w">    </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker.io

<span class="w">    </span><span class="c1"># Tell Docker to listen on all interfaces.</span>
<span class="w">    </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^#DOCKER_OPTS=.*$/DOCKER_OPTS=&quot;-H 0.0.0.0:2375&quot;/&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_ROOTFS</span><span class="s2">/etc/default/docker&quot;</span>
<span class="w">    </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>docker

<span class="w">    </span><span class="c1"># Join the Swarm.</span>
<span class="w">    </span><span class="nv">SWARM_AGENT_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Po<span class="w"> </span><span class="s1">&#39;(?&lt;=inet addr:)\S+&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--restart<span class="o">=</span>always<span class="w"> </span>--name<span class="o">=</span>swarm<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>swarm<span class="w"> </span>join<span class="w"> </span>--addr<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SWARM_AGENT_IP</span><span class="s2">:2375&quot;</span><span class="w"> </span><span class="s2">&quot;etcd://</span><span class="nv">$SWARM_MANAGER_IP</span><span class="s2">:2379&quot;</span>
<span class="k">done</span>
</code></pre></div>

<p>Be sure to change the values for <code>SWARM_MANAGER_IP</code>, <code>DOWNLOAD_DIST</code>, <code>DOWNLOAD_RELEASE</code> and <code>DOWNLOAD_ARCH</code> to fit your needs.</p>
<p>Thanks to this script, creating 10 new agents is as simple as running one command:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@host:~# </span>./swarm-agent-create<span class="w"> </span>swarm-agent-<span class="o">{</span><span class="m">0</span>..9<span class="o">}</span>
</code></pre></div>

<p>Here’s an explanation of what the script does:</p>
<ul>
<li>
<p>It first sets up a new LXC container following steps 1-5 above, that is: create a new LXC container (with <code>lxc-create</code>), apply the LXC configuration (<code>lxc.aa_profile</code> and <code>lxc.cap.drop</code> rules), start the container and install Docker.</p>
<div class="highlight"><pre><span></span><code><span class="nv">LXC_PATH</span><span class="o">=</span><span class="s2">&quot;/var/lib/lxc/</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
<span class="nv">LXC_ROOTFS</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$LXC_PATH</span><span class="s2">/rootfs&quot;</span>

<span class="c1"># Create the container.</span>
lxc-create<span class="w"> </span>-t<span class="w"> </span>download<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_DIST</span><span class="s2">&quot;</span><span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_RELEASE</span><span class="s2">&quot;</span><span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$DOWNLOAD_ARCH</span><span class="s2">&quot;</span>

cat<span class="w"> </span><span class="s">&lt;&lt;EOF &gt;&gt; &quot;$LXC_PATH/config&quot;</span>
<span class="s"># Allow running Docker inside LXC</span>
<span class="s">lxc.aa_profile = unconfined</span>
<span class="s">lxc.cap.drop =</span>
<span class="s">EOF</span>

<span class="c1"># Start the container and wait for networking to start.</span>
lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span>
sleep<span class="w"> </span>10s

<span class="c1"># Install Docker.</span>
lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>apt-get<span class="w"> </span>update
lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>docker.io
</code></pre></div>

</li>
<li>
<p>Our Swarm agents need to be reachable by the manager. For this reason we need to configure them so that they bind to a public interface. To do so, the script adds <code>DOCKER_OPTS="-H 0.0.0.0:2375"</code> and restarts Docker.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Tell Docker to listen on all interfaces.</span>
sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/^#DOCKER_OPTS=.*$/DOCKER_OPTS=&quot;-H 0.0.0.0:2375&quot;/&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_ROOTFS</span><span class="s2">/etc/default/docker&quot;</span>
lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>docker
</code></pre></div>

</li>
<li>
<p>Lastly, the script checks the IP address for the LXC container and it launches Swarm.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Join the Swarm.</span>
<span class="nv">SWARM_AGENT_IP</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Po<span class="w"> </span><span class="s1">&#39;(?&lt;=inet addr:)\S+&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
lxc-attach<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LXC_NAME</span><span class="s2">&quot;</span><span class="w"> </span>--<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--restart<span class="o">=</span>always<span class="w"> </span>--name<span class="o">=</span>swarm<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>swarm<span class="w"> </span>join<span class="w"> </span>--addr<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SWARM_AGENT_IP</span><span class="s2">:2375&quot;</span><span class="w"> </span><span class="s2">&quot;etcd://</span><span class="nv">$SWARM_MANAGER_IP</span><span class="s2">:2379&quot;</span>
</code></pre></div>

</li>
</ul>
<h1 id="step-8">Step 8: Play with the Swarm</h1>
<p>Now, if we check <code>docker info</code> on the Swarm manager, we should see 10 healthy nodes:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>-H<span class="w"> </span>localhost:3375<span class="w"> </span>info
<span class="go">Containers: 10</span>
<span class="go"> Running: 10</span>
<span class="go"> Paused: 0</span>
<span class="go"> Stopped: 0</span>
<span class="go">Images: 10</span>
<span class="go">Server Version: swarm/1.1.3</span>
<span class="go">Role: primary</span>
<span class="go">Strategy: spread</span>
<span class="go">Filters: health, port, dependency, affinity, constraint</span>
<span class="go">Nodes: 10</span>
<span class="go"> swarm-agent-0: 10.0.3.73:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:35Z</span>
<span class="go"> swarm-agent-1: 10.0.3.97:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:49Z</span>
<span class="go"> swarm-agent-2: 10.0.3.58:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:54Z</span>
<span class="go"> swarm-agent-3: 10.0.3.195:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:03Z</span>
<span class="go"> swarm-agent-4: 10.0.3.235:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:22Z</span>
<span class="go"> swarm-agent-5: 10.0.3.174:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:16Z</span>
<span class="go"> swarm-agent-6: 10.0.3.222:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:21Z</span>
<span class="go"> swarm-agent-7: 10.0.3.140:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:31:43Z</span>
<span class="go"> swarm-agent-8: 10.0.3.95:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:17Z</span>
<span class="go"> swarm-agent-9: 10.0.3.125:2375</span>
<span class="go">  └ Status: Healthy</span>
<span class="go">  └ Containers: 1</span>
<span class="go">  └ Reserved CPUs: 0 / 4</span>
<span class="go">  └ Reserved Memory: 0 B / 4.052 GiB</span>
<span class="go">  └ Labels: executiondriver=native-0.2, kernelversion=4.4.0-15-generic, operatingsystem=Ubuntu 16.04, storagedriver=overlay</span>
<span class="go">  └ Error: (none)</span>
<span class="go">  └ UpdatedAt: 2016-04-13T15:32:30Z</span>
<span class="go">Plugins:</span>
<span class="go"> Volume:</span>
<span class="go"> Network:</span>
<span class="go">Kernel Version: 4.4.0-15-generic</span>
<span class="go">Operating System: linux</span>
<span class="go">Architecture: amd64</span>
<span class="go">CPUs: 40</span>
<span class="go">Total Memory: 40.52 GiB</span>
<span class="go">Name: d39c33295ef3</span>
</code></pre></div>

<p>Let’s try running a command on the Swarm:</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@swarm-manager:~# </span>docker<span class="w"> </span>-H<span class="w"> </span>localhost:3375<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>--rm<span class="w"> </span>docker/whalesay<span class="w"> </span>cowsay<span class="w"> </span><span class="s1">&#39;It works!&#39;</span>
<span class="go"> ___________</span>
<span class="go">&lt; It works! &gt;</span>
<span class="go"> -----------</span>
<span class="go">    \</span>
<span class="go">     \</span>
<span class="go">      \</span>
<span class="gp">                    #</span><span class="c1">#        .</span>
<span class="gp">              #</span><span class="c1"># ## ##       ==</span>
<span class="gp">           #</span><span class="c1"># ## ## ##      ===</span>
<span class="go">       /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;___/ ===</span>
<span class="go">  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~</span>
<span class="go">       \______ o          __/</span>
<span class="go">        \    \        __/</span>
<span class="go">          \____\______/</span>
</code></pre></div>

<h1 id="conclusion">Conclusion</h1>
<p>We created a Swarm cluster consisting of one manager and 10 agents, and we kept memory and disk usage low thanks to LXC containers. We also succeeded in confining our Docker containers with AppArmor. Overall, this setup is probably not ideal for use in a production environment, but very useful for simulating clusters on your laptop.</p>
<p>I hope you enjoyed the tutorial. Feel free to leave a comment if you have questions!</p></div>
      </div>
        <section id="comments" class="comments">
          <h2>Comments</h2>
          <div id="remark42"></div>
          <noscript>Comments are powered by <a href="https://remark42.com/">Remark42</a>. Enable JavaScript to see them.</noscript>
        </section>
    </article>
</main>    <footer id="main-footer"><p>Copyright &copy; 2015-2024 Andrea Corbellini</p>
<p><a href="https://creativecommons.org/licenses/by/4.0/" rel="license" title="CC-BY 4.0 International">Creative Commons Attribution 4.0 International License</a></p>
<p>Powered by <a href="https://getpelican.com/" title="Pelican">Pelican</a>, <a href="https://pages.github.com/" title="GitHub Pages">GitHub Pages</a>, and <a href="https://www.mathjax.org/" title="MathJax">MathJax</a></p></footer>
  </body>
</html>